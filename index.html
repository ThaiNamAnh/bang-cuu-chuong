<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ôn tập Bảng Cửu Chương</title>
        <!-- Sử dụng Tailwind CSS để giao diện đẹp hơn -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Sử dụng Google Fonts cho font chữ thân thiện -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <style>
            /* Tùy chỉnh font chữ cho toàn bộ trang */
            body {
                font-family: "Baloo 2", cursive;
            }
            /* Hiệu ứng khi di chuột vào nút */
            .btn-hover:hover {
                transform: scale(1.05);
            }
            /* Kiểu cho input */
            .answer-input {
                transition: border-color 0.3s, background-color 0.3s, color 0.3s;
            }
            /* Kiểu cho câu trả lời ĐÚNG */
            .correct {
                border-color: #16a34a; /* green-600 */
                background-color: #dcfce7; /* green-100 */
                color: #15803d; /* green-700 */
                font-weight: bold;
            }
            /* Kiểu cho câu trả lời SAI */
            .incorrect {
                border-color: #dc2626; /* red-600 */
                background-color: #fee2e2; /* red-100 */
                color: #b91c1c; /* red-700 */
                font-weight: bold;
            }
            /* Kiểu cho icon phản hồi (dấu tick và dấu chéo) */
            .feedback-icon {
                font-size: 1.75rem; /* Tăng kích thước icon */
                font-weight: bold;
                line-height: 1;
                width: 2rem; /* Dành không gian cho icon */
                display: inline-flex;
                align-items: center;
                justify-content: center;
                margin-left: 0.5rem;
            }
            .icon-correct {
                color: #16a34a; /* green-600 */
            }
            .icon-incorrect {
                color: #dc2626; /* red-600 */
            }
            /* Ngăn người dùng chọn văn bản trên các nút modal */
            .modal-button {
                user-select: none;
            }
        </style>
    </head>
    <body class="bg-blue-50 flex items-center justify-center min-h-screen p-4">
        <div
            class="w-full max-w-6xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8 text-center border-4 border-purple-400"
        >
            <!-- Tiêu đề -->
            <h1 class="text-3xl md:text-4xl font-bold text-purple-600 mb-2">
                Bé Vui Học Toán
            </h1>
            <p class="text-gray-500 mb-6">
                Hãy hoàn thành các phép tính dưới đây nhé!
            </p>

            <!-- Bộ lọc chọn bảng cửu chương -->
            <div
                class="mb-6 flex flex-col sm:flex-row items-center justify-center gap-2"
            >
                <label
                    for="table-select"
                    class="text-xl font-semibold text-gray-700"
                    >Chọn bảng cửu chương:</label
                >
                <select
                    id="table-select"
                    class="text-lg p-2 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:ring-purple-500"
                >
                    <option value="1">Bảng 1</option>
                    <option value="2">Bảng 2</option>
                    <option value="3" selected>Bảng 3</option>
                    <option value="4">Bảng 4</option>
                    <option value="5">Bảng 5</option>
                    <option value="6">Bảng 6</option>
                    <option value="7">Bảng 7</option>
                    <option value="8">Bảng 8</option>
                    <option value="9">Bảng 9</option>
                </select>
            </div>

            <!-- Khu vực hiển thị các phép toán (responsive) -->
            <div
                id="problems-grid"
                class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 my-6"
            >
                <!-- Các bài toán sẽ được tạo ở đây -->
            </div>

            <!-- Các nút hành động -->
            <div
                class="flex flex-col sm:flex-row items-center justify-center gap-4"
            >
                <button
                    id="check-btn"
                    class="w-full sm:w-auto bg-green-500 text-white font-bold text-xl px-8 py-4 rounded-lg shadow-md transition-transform duration-200 btn-hover"
                >
                    Kiểm tra kết quả
                </button>
                <button
                    id="new-problems-btn"
                    class="w-full sm:w-auto bg-purple-500 text-white font-bold text-xl px-8 py-4 rounded-lg shadow-md transition-transform duration-200 btn-hover"
                >
                    Làm bài mới
                </button>
            </div>

            <!-- Khu vực hiển thị thông báo -->
            <div class="mt-6">
                <div
                    id="message"
                    class="h-10 text-2xl font-semibold transition-all duration-300"
                ></div>
            </div>
        </div>

        <!-- Modal (popup) cho việc chọn đáp án trên di động -->
        <div
            id="choice-modal"
            class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50"
        >
            <div
                class="bg-white rounded-2xl shadow-2xl p-6 text-center w-full max-w-xs"
            >
                <!-- Tiêu đề của modal giờ sẽ hiển thị phép tính -->
                <h2
                    id="modal-question"
                    class="text-3xl font-bold text-purple-600 mb-6"
                ></h2>
                <div id="choice-buttons" class="grid grid-cols-2 gap-4">
                    <!-- Các nút chọn đáp án sẽ được chèn vào đây bằng JavaScript -->
                </div>
            </div>
        </div>

        <script>
            // Lấy các phần tử HTML cần thiết
            const tableSelect = document.getElementById("table-select");
            const problemsGrid = document.getElementById("problems-grid");
            const checkBtn = document.getElementById("check-btn");
            const newProblemsBtn = document.getElementById("new-problems-btn");
            const messageEl = document.getElementById("message");
            const choiceModal = document.getElementById("choice-modal");
            const choiceButtonsContainer =
                document.getElementById("choice-buttons");
            const modalQuestionEl = document.getElementById("modal-question");

            const NUM_PROBLEMS = 15;
            let problems = [];

            /**
             * Kiểm tra xem thiết bị có phải là di động hay không.
             * @returns {boolean} True nếu là di động, ngược lại là false.
             */
            function isMobile() {
                return window.innerWidth < 768;
            }

            /**
             * Tạo một bộ bài toán mới và hiển thị lên màn hình, đảm bảo không có phép tính trùng lặp.
             */
            function generateProblems() {
                const selectedTable = parseInt(tableSelect.value, 10);
                problemsGrid.innerHTML = "";
                messageEl.textContent = "";

                // 1. Tạo một kho chứa tất cả các phép tính có thể có (10 nhân, 10 chia)
                const problemPool = [];
                for (let i = 1; i <= 10; i++) {
                    // Phép nhân
                    problemPool.push({
                        question: `${selectedTable} x ${i} =`,
                        answer: selectedTable * i,
                    });
                    // Phép chia
                    problemPool.push({
                        question: `${selectedTable * i} ÷ ${selectedTable} =`,
                        answer: i,
                    });
                }

                // 2. Xáo trộn ngẫu nhiên kho phép tính (thuật toán Fisher-Yates)
                for (let i = problemPool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [problemPool[i], problemPool[j]] = [
                        problemPool[j],
                        problemPool[i],
                    ];
                }

                // 3. Lấy 15 phép tính đầu tiên từ kho đã xáo trộn
                problems = problemPool.slice(0, NUM_PROBLEMS);

                // 4. Hiển thị 15 phép tính đã chọn
                problems.forEach((problem, i) => {
                    const problemCard = document.createElement("div");
                    problemCard.className =
                        "bg-purple-50 p-4 rounded-lg shadow flex flex-col items-center justify-center";

                    problemCard.innerHTML = `
                    <p class="text-xl md:text-2xl font-bold text-gray-800 mb-2">${problem.question}</p>
                    <div class="flex items-center">
                        <input type="number" data-index="${i}" class="answer-input text-xl md:text-2xl text-center w-20 md:w-24 p-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-purple-500">
                        <span class="feedback-icon"></span>
                    </div>
                `;

                    problemsGrid.appendChild(problemCard);

                    // Lấy thẻ input vừa tạo để thêm sự kiện
                    const inputEl = problemCard.querySelector(".answer-input");
                    if (isMobile()) {
                        // Trên di động: không cho nhập, chỉ cho click để mở modal
                        inputEl.setAttribute("readonly", true);
                        inputEl.addEventListener("click", (event) => {
                            event.preventDefault();
                            const index = parseInt(inputEl.dataset.index, 10);
                            const currentProblem = problems[index];
                            showChoiceModal(
                                inputEl,
                                currentProblem.answer,
                                currentProblem.question
                            );
                        });
                    }
                });
            }

            /**
             * Hiển thị modal với các lựa chọn đáp án.
             * @param {HTMLElement} targetInput - Ô input cần điền giá trị.
             * @param {number} correctAnswer - Đáp án đúng.
             * @param {string} questionText - Phép tính đang được hỏi.
             */
            function showChoiceModal(targetInput, correctAnswer, questionText) {
                // Hiển thị phép tính trong tiêu đề của modal
                modalQuestionEl.textContent = questionText;
                choiceButtonsContainer.innerHTML = ""; // Xóa các nút cũ

                // Tạo tập hợp các đáp án, bao gồm đáp án đúng và 3 đáp án sai
                const choices = new Set([correctAnswer]);
                while (choices.size < 4) {
                    const offset = Math.floor(Math.random() * 5) + 1; // Tạo số ngẫu nhiên từ 1-5
                    const distractor =
                        Math.random() < 0.5
                            ? correctAnswer + offset
                            : correctAnswer - offset;
                    if (distractor >= 0 && distractor !== correctAnswer) {
                        // Đảm bảo đáp án sai khác đáp án đúng và không âm
                        choices.add(distractor);
                    }
                }

                // Xáo trộn các đáp án
                const shuffledChoices = Array.from(choices).sort(
                    () => Math.random() - 0.5
                );

                // Tạo nút cho từng đáp án
                shuffledChoices.forEach((choice) => {
                    const button = document.createElement("button");
                    button.className =
                        "modal-button bg-purple-500 text-white font-bold text-2xl p-4 rounded-lg shadow-md btn-hover";
                    button.textContent = choice;
                    button.addEventListener("click", () => {
                        targetInput.value = choice;
                        choiceModal.classList.add("hidden");
                    });
                    choiceButtonsContainer.appendChild(button);
                });

                // Hiển thị modal
                choiceModal.classList.remove("hidden");
            }

            /**
             * Kiểm tra tất cả các câu trả lời và hiển thị phản hồi.
             */
            function checkAnswers() {
                const inputs = document.querySelectorAll(".answer-input");
                let correctCount = 0;

                inputs.forEach((input) => {
                    const index = parseInt(input.dataset.index, 10);
                    const userAnswer = parseInt(input.value, 10);
                    const correctAnswer = problems[index].answer;
                    const icon = input.nextElementSibling;

                    input.classList.remove("correct", "incorrect");
                    icon.textContent = "";
                    icon.className = "feedback-icon";

                    if (!isNaN(userAnswer) && userAnswer === correctAnswer) {
                        input.classList.add("correct");
                        icon.textContent = "✓";
                        icon.classList.add("icon-correct");
                        correctCount++;
                    } else {
                        input.classList.add("incorrect");
                        icon.textContent = "✗";
                        icon.classList.add("icon-incorrect");
                    }
                });

                // Hiển thị thông báo kết quả tổng kết
                if (correctCount === NUM_PROBLEMS) {
                    messageEl.textContent = `Tuyệt vời! Bạn đã đúng tất cả ${NUM_PROBLEMS} câu! 🌟`;
                    messageEl.className =
                        "h-10 text-2xl font-semibold text-green-500";
                } else {
                    messageEl.textContent = `Bạn đã làm đúng ${correctCount}/${NUM_PROBLEMS} câu. Cố lên nhé!`;
                    messageEl.className =
                        "h-10 text-2xl font-semibold text-orange-500";
                }
            }

            // Gán sự kiện cho các nút và bộ lọc
            checkBtn.addEventListener("click", checkAnswers);
            newProblemsBtn.addEventListener("click", generateProblems);
            tableSelect.addEventListener("change", generateProblems);

            // Đóng modal khi click ra ngoài vùng chọn
            choiceModal.addEventListener("click", (event) => {
                if (event.target === choiceModal) {
                    choiceModal.classList.add("hidden");
                }
            });

            // Tải bộ bài toán đầu tiên khi trang được mở
            window.onload = generateProblems;
        </script>
    </body>
</html>
